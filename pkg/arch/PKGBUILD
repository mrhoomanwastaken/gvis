# Maintainer: mrhooman <113311405+mrhoomanwastaken@users.noreply.github.com>
pkgname=gvis
pkgver=0.5
pkgrel=1
pkgdesc="A music visualizer based on cavacore and built with Gtk+3"
arch=('x86_64' 'aarch64')
url="https://github.com/mrhoomanwastaken/gvis"
license=('GPL')
depends=('gtk3' 'mesa' 'dbus')
makedepends=('python' 'python-pip' 'git')
source=("${pkgname}-${pkgver}.tar.gz::https://github.com/mrhoomanwastaken/gvis/archive/refs/tags/v${pkgver}.tar.gz")
sha256sums=('37cd498cbd5355f757073ae7e1ffd49f8a066c4fd1db91e170b7531945a3e7ff')

prepare() {
    cd "${srcdir}/${pkgname}-${pkgver}"
    
    # Create blank .env file if it doesn't exist
    if [ ! -f .env ]; then
        touch .env
    fi
}

build() {
    cd "${srcdir}/${pkgname}-${pkgver}"
    
    # Disable LTO for Nuitka compilation to avoid plugin conflicts
    export CFLAGS="${CFLAGS/-flto=auto/}"
    export CXXFLAGS="${CXXFLAGS/-flto=auto/}"
    export LDFLAGS="${LDFLAGS/-flto=auto/}"
    
    # Run make compile to build the binary
    make mkconfig
    make compile
}

package() {
    cd "${srcdir}/${pkgname}-${pkgver}"
    
    # Install binary
    install -Dm755 nudist/gvis.bin "${pkgdir}/usr/bin/gvis"
    
    # Install desktop file
    install -Dm644 gvis.desktop "${pkgdir}/usr/share/applications/gvis.desktop"
    
    # Install license
    install -Dm644 LICENSE "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}
